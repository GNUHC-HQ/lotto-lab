<!DOCTYPE html>
<html lang="ko">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-021EWQE074"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-021EWQE074');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† ë¡œë˜ ì—°êµ¬ì†Œ ğŸ†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #121212; --primary-bg: #1e1e1e; --text-color: #e0e0e0;
            --link-color: #bb86fc; --border-color: #333333; --button-bg: #bb86fc;
            --button-text: #121212; --chart-grid-color: rgba(255, 255, 255, 0.1);
        }
        body { margin: 0; font-family: sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .container { display: flex; width: 100%; min-height: 100vh; }
        .left-ad, .right-ad { flex: 1; background-color: var(--primary-bg); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #555; }
        .main-content { flex: 2; padding: 20px 40px; text-align: center; overflow-y: auto; }
        h1 { color: var(--text-color); }
        form { margin: 20px 0; }
        form input[type="number"] { padding: 10px; width: 100px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); font-size: 16px; }
        form button { padding: 10px 20px; border-radius: 5px; border: none; background-color: var(--button-bg); color: var(--button-text); font-size: 16px; font-weight: bold; cursor: pointer; }
        .form-inputs { display: inline-flex; align-items: center; gap: 10px; margin-right: 15px; }
        .latest-info-section { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 30px; }
        .latest-numbers h3 { margin: 0 0 15px 0; font-size: 1rem; color: #aaa; }
        .ball-container { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .lotto-ball { display: inline-flex; justify-content: center; align-items: center; width: 40px; height: 40px; border-radius: 50%; color: #fff; font-weight: bold; font-size: 1.1rem; }
        .color-yellow { background-color: #fbc400; } .color-blue { background-color: #69c8f2; } .color-red { background-color: #ff7272; }
        .color-gray { background-color: #aaa; } .color-green { background-color: #b0d840; }
        .plus-sign { font-size: 1.5rem; color: #888; }
        .countdown-section { display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .countdown-item h4 { margin: 0 0 8px 0; font-size: 0.9rem; color: #aaa; }
        .countdown-item div { font-size: 1.2rem; font-weight: bold; color: var(--link-color); }
        .tab-container { margin-top: 20px; width: 100%; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); }
        .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; color: #888; background-color: transparent; border: none; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--link-color); border-bottom: 3px solid var(--link-color); }
        .tab-content-container { padding: 20px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .error-message { color: #ff7272; font-weight: bold; background-color: rgba(255, 114, 114, 0.1); border: 1px solid #ff7272; border-radius: 5px; padding: 10px; margin: 15px 0; }
        .info-text { margin-top: 20px; margin-bottom: 20px; }
        .range-info, .date-range-info { font-size: 14px; color: #aaa; margin: 5px 0; }
        .birthday-results-container { margin-top: 20px; text-align: left; max-height: 400px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .result-info { flex-grow: 1; } .result-info h4 { margin: 0 0 5px 0; } .result-info p { margin: 0; color: #aaa; font-size: 0.9rem; }
        .no-results { color: #aaa; text-align: center; padding: 20px; }
        .generate-btn { padding: 12px 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; background-color: var(--button-bg); color: var(--button-text); }
        #generator-controls { margin-bottom: 20px; }
        .generation-info { text-align: center; color: #aaa; margin-top: 20px; min-height: 1.2em; }
        .generator-grid-container { display: flex; flex-direction: column; gap: 10px; }
        .lotto-ball.shuffling { filter: blur(2px); transition: filter 0.1s; }
        #chart-container { width: 100%; max-width: 900px; margin: 40px auto; }
        .lab-container { display: flex; gap: 20px; align-items: flex-start; }
        .lab-number-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--primary-bg); flex-shrink: 0; width: fit-content; }
        .lab-ball-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-color); color: var(--text-color); font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .lab-ball-btn:hover { background-color: #555; }
        .lab-ball-btn.selected { color: var(--button-text); transform: scale(1.1); }
        .lab-results { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background-color: var(--primary-bg); text-align: left; min-height: 300px; }
        .lab-placeholder { color: #888; text-align: center; margin-top: 50px; }
        .lab-results h4 { margin-top: 15px; margin-bottom: 8px; color: var(--link-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .lab-results p { margin: 5px 0; color: #ccc; }
        .lab-results ul { list-style: none; padding-left: 10px; }
        .lab-results li { margin-bottom: 5px; }
        .lab-results .probability { font-weight: bold; color: #fff; }
        .no-data { color: #888; font-style: italic; }

        @media (max-width: 768px) {
            .left-ad, .right-ad { display: none; }
            .main-content { flex: 1; padding: 15px; }
            .lotto-ball { width: 35px; height: 35px; font-size: 1rem; }
            .ball-container { gap: 5px; flex-wrap: wrap; }
            .form-inputs { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
            h1 { font-size: 1.8rem; }
            .lab-container { flex-direction: column; }
            .lab-number-grid { grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); width: 100%; }
            .lab-ball-btn { width: 35px; height: 35px; }
            .lab-results { min-height: auto; width: calc(100% - 40px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-ad"> </div>
        <div class="main-content">
            <h1>ğŸ† ë¡œë˜ ì—°êµ¬ì†Œ ğŸ†</h1>

            {% if latest_winning_numbers %}
            <div class="latest-info-section">
                <div class="latest-numbers">
                    <h3>{{ latest_winning_numbers.round }}íšŒ ë‹¹ì²¨ë²ˆí˜¸ ({{ latest_winning_numbers.date }})</h3>
                    <div class="ball-container">
                        {% for num in latest_winning_numbers.main %}
                            {% set ball_color = 'color-yellow' if 1 <= num <= 10 else 'color-blue' if 11 <= num <= 20 else 'color-red' if 21 <= num <= 30 else 'color-gray' if 31 <= num <= 40 else 'color-green' %}
                            <span class="lotto-ball {{ ball_color }}">{{ num }}</span>
                        {% endfor %}
                        <span class="plus-sign">+</span>
                        {% set bonus_num = latest_winning_numbers.bonus %}
                        {% set bonus_ball_color = 'color-yellow' if 1 <= bonus_num <= 10 else 'color-blue' if 11 <= bonus_num <= 20 else 'color-red' if 21 <= bonus_num <= 30 else 'color-gray' if 31 <= bonus_num <= 40 else 'color-green' %}
                        <span class="lotto-ball {{ bonus_ball_color }}">{{ bonus_num }}</span>
                    </div>
                </div>
                <div class="countdown-section">
                    <div class="countdown-item"><h4>ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€</h4><div id="draw-countdown">--ì¼ --ì‹œê°„ --ë¶„ --ì´ˆ</div></div>
                    <div class="countdown-item"><h4>êµ¬ë§¤ ë§ˆê°ê¹Œì§€</h4><div id="sales-countdown">--ì¼ --ì‹œê°„ --ë¶„ --ì´ˆ</div></div>
                </div>
            </div>
            {% endif %}

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab-btn" data-tab="statistics">ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸ í†µê³„ ë¶„ì„</div>
                    <div class="tab-btn" data-tab="birthday">ê¸°ë…ì¼ ë‹¹ì²¨ë²ˆí˜¸ ê²€ìƒ‰</div>
                    <div class="tab-btn" data-tab="generator">ìë™ ë²ˆí˜¸ ìƒì„±ê¸°</div>
                    <div class="tab-btn" data-tab="lab">ì‹¤í—˜ì‹¤</div>
                </div>

                <div class="tab-content-container">
                    <div class="tab-content" data-tab="statistics">
                        {% if error_message %}<div class="error-message">{{ error_message }}</div>{% endif %}
                        <form action="/" method="get">
                            <div class="form-inputs">
                                <input type="number" id="start-round" name="start_round" placeholder="1" value="{{ current_start }}"><label for="start-round">íšŒì°¨ë¶€í„°</label>
                                <input type="number" id="end-round" name="end-round" placeholder="{{ latest_round }}" value="{{ current_end }}"><label for="end-round">ê¹Œì§€</label>
                            </div>
                            <button type="submit">í†µê³„ ë¶„ì„</button>
                        </form>
                        <div class="info-text">
                            <p class="range-info">(ì…ë ¥ ê°€ëŠ¥ ë²”ìœ„: 1 ~ {{ latest_round }} íšŒì°¨)</p>
                            <p class="range-info">*ì¶”ì²œ íšŒì°¨ ë²”ìœ„: 836 ~ (í™©ê¸ˆì† ì¶”ì²¨ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)</p>
                            <p class="date-range-info">ë¶„ì„ ê¸°ê°„: {{ end_date }} ~ {{ start_date }}</p>
                        </div>
                        <div id="chart-container"><canvas id="lottoChart"></canvas></div>
                    </div>

                    <div class="tab-content" data-tab="birthday">
                        <form action="/" method="get">
                            <div class="form-inputs">
                                <input type="number" name="birth_month" placeholder="ì›”" value="{{ current_month }}"><label>ì›”</label>
                                <input type="number" name="birth_day" placeholder="ì¼" value="{{ current_day }}"><label>ì¼</label>
                            </div>
                            <button type="submit">ì°¾ì•„ë³´ê¸°</button>
                        </form>
                        <div class="birthday-results-container">
                             {% if birthday_section_open %}
                                {% if birthday_lotto_results %}
                                    {% for result in birthday_lotto_results %}
                                        <div class="result-item">
                                            <div class="result-info"><h4>{{ result.round }}íšŒ ë‹¹ì²¨</h4><p>{{ result.date }}</p></div>
                                            <div class="ball-container">
                                                {% for num in result.main %}
                                                    {% set ball_color = 'color-yellow' if 1 <= num <= 10 else 'color-blue' if 11 <= num <= 20 else 'color-red' if 21 <= num <= 30 else 'color-gray' if 31 <= num <= 40 else 'color-green' %}
                                                    <span class="lotto-ball {{ ball_color }}">{{ num }}</span>
                                                {% endfor %}
                                                <span class="plus-sign">+</span>
                                                {% set bonus_num = result.bonus %}
                                                {% set bonus_ball_color = 'color-yellow' if 1 <= bonus_num <= 10 else 'color-blue' if 11 <= bonus_num <= 20 else 'color-red' if 21 <= bonus_num <= 30 else 'color-gray' if 31 <= bonus_num <= 40 else 'color-green' %}
                                                <span class="lotto-ball {{ bonus_ball_color }}">{{ bonus_num }}</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}<p class="no-results">í•´ë‹¹ ë‚ ì§œì˜ ë‹¹ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-content" data-tab="generator">
                        <div id="generator-controls">
                            <button id="generate-btn" class="generate-btn">ë²ˆí˜¸ ìƒì„±í•˜ê¸°</button>
                            <p id="generation-timestamp" class="generation-info"></p>
                        </div>
                        <div id="generator-grid" class="generator-grid-container"></div>
                    </div>

                    <div class="tab-content" data-tab="lab">
                        <div class="lab-container">
                            <div class="lab-number-grid">
                                {% for i in range(1, 46) %}
                                    {# ë²ˆí˜¸ ê°’ì— ë”°ë¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì • #}
                                    {% set ball_color = 'color-yellow' if 1 <= i <= 10 else
                                                        'color-blue' if 11 <= i <= 20 else
                                                        'color-red' if 21 <= i <= 30 else
                                                        'color-gray' if 31 <= i <= 40 else
                                                        'color-green' %}
                                    {# ê²°ì •ëœ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ë²„íŠ¼ì— ì¶”ê°€ #}
                                    <button class="lab-ball-btn {{ ball_color }}" data-number="{{ i }}">{{ i }}</button>
                                {% endfor %}
                            </div>
                            <div class="lab-results">
                                <p class="lab-placeholder">ì™¼ìª½ì—ì„œ ë¶„ì„í•  ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-ad"> </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. ê³µí†µ ë³€ìˆ˜ ì„ ì–¸ ---
            const tabsContainer = document.querySelector('.tabs');
            const tabContents = document.querySelectorAll('.tab-content');
            const generateBtn = document.getElementById('generate-btn');
            const generatorGrid = document.getElementById('generator-grid');
            const timestampElem = document.getElementById('generation-timestamp');
            const labNumberGrid = document.querySelector('.lab-number-grid');
            const labResultsContainer = document.querySelector('.lab-results');
            const labPlaceholder = document.querySelector('.lab-placeholder');

            let shufflingInterval = null;
            let selectedLabBall = null; // ì‹¤í—˜ì‹¤ì—ì„œ ì„ íƒëœ ë²ˆí˜¸ ë²„íŠ¼ ìš”ì†Œ
            let lottoChartInstance = null; // ì°¨íŠ¸ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜

            // --- 2. ì¹´ìš´íŠ¸ë‹¤ìš´ ê¸°ëŠ¥ ---
            function updateCountdowns() {
                const now = new Date();
                let nextSaturday = new Date(now);
                nextSaturday.setDate(now.getDate() + (6 - now.getDay() + 7) % 7);
                const drawTime = new Date(nextSaturday); drawTime.setHours(20, 35, 0, 0);
                const salesDeadline = new Date(nextSaturday); salesDeadline.setHours(20, 0, 0, 0);
                if (now > drawTime) { drawTime.setDate(drawTime.getDate() + 7); salesDeadline.setDate(salesDeadline.getDate() + 7); }
                else if (now > salesDeadline) { salesDeadline.setDate(salesDeadline.getDate() + 7); }
                const drawElem = document.getElementById('draw-countdown');
                const salesElem = document.getElementById('sales-countdown');
                function updateElement(elem, targetTime) {
                    const diff = targetTime - now; if (diff <= 0) { elem.innerHTML = "ë§ˆê°"; return; }
                    const d=Math.floor(diff/864e5),h=Math.floor(diff%864e5/36e5),m=Math.floor(diff%36e5/6e4),s=Math.floor(diff%6e4/1e3);
                    elem.innerHTML = `${d}ì¼ ${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
                }
                if(drawElem) updateElement(drawElem, drawTime);
                if(salesElem) updateElement(salesElem, salesDeadline);
            }
            setInterval(updateCountdowns, 1000);
            updateCountdowns();

            // --- 3. íƒ­ ê¸°ëŠ¥ ---
            tabsContainer.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.tab-btn');
                if (!clickedTab) return;

                const tabId = clickedTab.dataset.tab;

                // ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì´ë™ ì‹œ ê´€ë ¨ ê¸°ëŠ¥ ì´ˆê¸°í™”
                if (tabId !== 'generator') {
                    if (shufflingInterval) clearInterval(shufflingInterval);
                    generatorGrid.innerHTML = '';
                    timestampElem.textContent = '';
                    if(generateBtn) {
                         generateBtn.disabled = false;
                         generateBtn.textContent = 'ë²ˆí˜¸ ìƒì„±í•˜ê¸°';
                    }
                }
                if (tabId !== 'lab') {
                     if (selectedLabBall) {
                         selectedLabBall.classList.remove('selected');
                         selectedLabBall = null;
                     }
                     if (labResultsContainer) {
                         labResultsContainer.innerHTML = '<p class="lab-placeholder">ì™¼ìª½ì—ì„œ ë¶„ì„í•  ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
                     }
                }

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                clickedTab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                const activeContent = document.querySelector(`.tab-content[data-tab="${tabId}"]`);
                if (activeContent) activeContent.classList.add('active');

                // âœ¨ í†µê³„ íƒ­ì´ í™œì„±í™”ë˜ë©´ ì°¨íŠ¸ë¥¼ ê·¸ë¦¼ (ì´ë¯¸ ê·¸ë ¤ì ¸ ìˆë‹¤ë©´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•ŠìŒ)
                if (tabId === 'statistics' && !lottoChartInstance) {
                    initializeChart();
                }
            });

            // --- 4. ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ ---
            function initializeChart() {
                const chartCtx = document.getElementById('lottoChart');
                if (chartCtx) {
                    const chartLabels = {{ chart_labels | tojson }};
                    const chartData = {{ chart_data | tojson }};
                    const chartOptions = {
                        scales: {
                            y: { beginAtZero: true, ticks: { color: 'rgba(255, 255, 255, 0.7)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: 'rgba(255, 255, 255, 0.7)', autoSkip: false }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        },
                        plugins: { legend: { labels: { color: 'rgba(255, 255, 255, 0.9)' } } }
                    };
                    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
                    lottoChartInstance = new Chart(chartCtx.getContext('2d'), {
                        type: 'bar',
                        data: { labels: chartLabels, datasets: [{ label: 'ë²ˆí˜¸ë³„ ë‹¹ì²¨ íšŸìˆ˜', data: chartData, backgroundColor: 'rgba(187, 134, 252, 0.6)', borderColor: 'rgba(187, 134, 252, 1)', borderWidth: 1 }] },
                        options: chartOptions
                    });
                }
            }

            // --- 5. ìë™ ë²ˆí˜¸ ìƒì„±ê¸° ê¸°ëŠ¥ ---
            if (generateBtn) {
                generateBtn.addEventListener('click', () => {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'ë²ˆí˜¸ ìƒì„± ì¤‘...';
                    timestampElem.textContent = '';
                    generatorGrid.innerHTML = '';
                    if (shufflingInterval) clearInterval(shufflingInterval);

                    const allBalls = [];
                    for (let i = 0; i < 5; i++) {
                        const setContainer = document.createElement('div');
                        setContainer.className = 'ball-container';
                        for (let j = 0; j < 6; j++) {
                            const ball = document.createElement('span');
                            ball.className = 'lotto-ball shuffling';
                            ball.textContent = Math.floor(Math.random() * 45) + 1;
                            setContainer.appendChild(ball);
                            allBalls.push(ball);
                        }
                        generatorGrid.appendChild(setContainer);
                    }

                    shufflingInterval = setInterval(() => {
                        allBalls.forEach(ball => {
                            ball.textContent = Math.floor(Math.random() * 45) + 1;
                        });
                    }, 80);

                    fetch('/api/generate-numbers')
                        .then(response => response.json())
                        .then(numberSets => {
                            setTimeout(() => {
                                clearInterval(shufflingInterval);
                                const finalNumbers = numberSets.flat();
                                allBalls.forEach((ball, index) => {
                                    setTimeout(() => {
                                        const finalNum = finalNumbers[index];
                                        ball.textContent = finalNum;
                                        ball.classList.remove('shuffling');
                                        let colorClass = 'color-green';
                                        if (finalNum <= 10) colorClass = 'color-yellow';
                                        else if (finalNum <= 20) colorClass = 'color-blue';
                                        else if (finalNum <= 30) colorClass = 'color-red';
                                        else if (finalNum <= 40) colorClass = 'color-gray';
                                        ball.className = 'lotto-ball ' + colorClass;
                                        if (index === allBalls.length - 1) {
                                            generateBtn.disabled = false;
                                            generateBtn.textContent = 'ë‹¤ì‹œ ìƒì„±í•˜ê¸°';
                                            const now = new Date();
                                            timestampElem.textContent = `ìš°ì£¼ì˜ ê¸°ìš´ì„ ëª¨ì•„ ${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ ${now.getHours()}ì‹œ ${now.getMinutes()}ë¶„ ${now.getSeconds()}ì´ˆì— ìƒì„±ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤!`;
                                        }
                                    }, 100 * index);
                                });
                            }, 1000);
                        })
                        .catch(error => {
                            console.error('Error fetching numbers:', error);
                            generateBtn.disabled = false;
                            generateBtn.textContent = 'ì˜¤ë¥˜ ë°œìƒ! ë‹¤ì‹œ ì‹œë„';
                            clearInterval(shufflingInterval);
                        });
                });
            }

            // --- 6. ì‹¤í—˜ì‹¤ ê¸°ëŠ¥ ---
            if (labNumberGrid && labResultsContainer) {
                 labNumberGrid.addEventListener('click', (e) => {
                    const clickedBall = e.target.closest('.lab-ball-btn');
                    if (!clickedBall) return;

                    const number = clickedBall.dataset.number;

                    if (selectedLabBall) selectedLabBall.classList.remove('selected');
                    clickedBall.classList.add('selected');
                    selectedLabBall = clickedBall;

                    labResultsContainer.innerHTML = '<p class="lab-placeholder">ë°ì´í„° ë¶„ì„ ì¤‘...</p>';

                    fetch(`/api/analyze-number/${number}`)
                        .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
                        .then(data => displayLabResults(number, data))
                        .catch(error => {
                            console.error('Error fetching analysis:', error);
                            labResultsContainer.innerHTML = '<p class="lab-placeholder" style="color:red;">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                        });
                });
            }

            // ë¶„ì„ ê²°ê³¼ë¥¼ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
            function displayLabResults(number, data) {
                 if (!labResultsContainer) return;
                 labResultsContainer.innerHTML = `<h4>1. ${number}ë²ˆ ë‹¹ì²¨ í™•ë¥ </h4><p>ì—­ëŒ€ ì´ ${data.appearance_count}ë²ˆ ë“±ì¥ (<span class="probability">${(data.probability * 100).toFixed(2)}%</span>)</p>`;
                 labResultsContainer.innerHTML += formatProbList(`2. ${number}ë²ˆ ì´ì „ì— ë‚˜ì˜¬ í™•ë¥  (Top 3)`, data.prev_top3);
                 labResultsContainer.innerHTML += formatProbList(`3. ${number}ë²ˆ ì´ì „ì— ë‚˜ì˜¬ í™•ë¥  (Bottom 3)`, data.prev_bottom3);
                 labResultsContainer.innerHTML += formatProbList(`4. ${number}ë²ˆ ë‹¤ìŒì— ë‚˜ì˜¬ í™•ë¥  (Top 3)`, data.next_top3);
                 labResultsContainer.innerHTML += formatProbList(`5. ${number}ë²ˆ ë‹¤ìŒì— ë‚˜ì˜¬ í™•ë¥  (Bottom 3)`, data.next_bottom3);
                 labResultsContainer.innerHTML += `<h4>6. ${number}ë²ˆ ìµœëŒ€ ì—°ì† ë“±ì¥ íšŸìˆ˜</h4><p><span class="probability">${data.max_consecutive}íšŒ</span></p>`;
            }

            // í™•ë¥  ëª©ë¡ í‘œì‹œ Helper í•¨ìˆ˜
            function formatProbList(title, list) {
                let html = `<h4>${title}</h4>`;
                if (list && list.length > 0) {
                    html += '<ul>';
                    list.forEach(item => { html += `<li>${item[0]}ë²ˆ: <span class="probability">${(item[1] * 100).toFixed(2)}%</span></li>`; });
                    html += '</ul>';
                } else {
                    html += '<p class="no-data">í•´ë‹¹í•˜ëŠ” ìˆ«ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                return html;
            }

             // --- 7. í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ íƒ­ í™œì„±í™” ---
             // ì´ ì½”ë“œëŠ” ë‹¤ë¥¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì´ ëª¨ë‘ ì„¤ì •ëœ *í›„*ì— ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
             const defaultTabId = {% if birthday_section_open %}'birthday'{% elif analysis_section_open %}'statistics'{% else %}'statistics'{% endif %};
             const defaultTab = document.querySelector(`.tab-btn[data-tab="${defaultTabId}"]`);
             if (defaultTab) {
                 defaultTab.click(); // .click()ìœ¼ë¡œ íƒ­ í™œì„±í™” ë¡œì§ ì‹¤í–‰
             } else {
                 // í˜¹ì‹œ defaultTabì„ ëª» ì°¾ì„ ê²½ìš° ëŒ€ë¹„, ì²« ë²ˆì§¸ íƒ­ì´ë¼ë„ í™œì„±í™”
                 const firstTab = document.querySelector('.tab-btn');
                 if (firstTab) firstTab.click();
             }

        }); // End of document.addEventListener('DOMContentLoaded', ...)
    </script>
</body>
</html>