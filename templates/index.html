<!DOCTYPE html>
<html lang="ko">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-021EWQE074"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-021EWQE074');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† ë¡œë˜ ì—°êµ¬ì†Œ ğŸ†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #121212; --primary-bg: #1e1e1e; --text-color: #e0e0e0;
            --link-color: #bb86fc; --border-color: #333333; --button-bg: #bb86fc;
            --button-text: #121212; --chart-grid-color: rgba(255, 255, 255, 0.1);
        }
        body { margin: 0; font-family: sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .container { display: flex; width: 100%; min-height: 100vh; }
        .left-ad, .right-ad { flex: 1; background-color: var(--primary-bg); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #555; }
        .main-content { flex: 2; padding: 20px 40px; text-align: center; overflow-y: auto; }
        h1 { color: var(--text-color); }
        form { margin: 20px 0; }
        form input[type="number"] { padding: 10px; width: 100px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); font-size: 16px; }
        form button { padding: 10px 20px; border-radius: 5px; border: none; background-color: var(--button-bg); color: var(--button-text); font-size: 16px; font-weight: bold; cursor: pointer; }
        .form-inputs { display: inline-flex; align-items: center; gap: 10px; margin-right: 15px; }
        .latest-info-section { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 30px; }
        .latest-numbers h3 { margin: 0 0 15px 0; font-size: 1rem; color: #aaa; }
        .ball-container { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .lotto-ball { display: inline-flex; justify-content: center; align-items: center; width: 40px; height: 40px; border-radius: 50%; color: #fff; font-weight: bold; font-size: 1.1rem; }
        .color-yellow { background-color: #fbc400; } .color-blue { background-color: #69c8f2; } .color-red { background-color: #ff7272; }
        .color-gray { background-color: #aaa; } .color-green { background-color: #b0d840; }
        .plus-sign { font-size: 1.5rem; color: #888; }
        .countdown-section { display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .countdown-item h4 { margin: 0 0 8px 0; font-size: 0.9rem; color: #aaa; }
        .countdown-item div { font-size: 1.2rem; font-weight: bold; color: var(--link-color); }
        .tab-container { margin-top: 20px; width: 100%; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; /* Allow tabs to wrap on mobile */ }
        .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; color: #888; background-color: transparent; border: none; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; white-space: nowrap; /* Prevent button text wrapping */ }
        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--link-color); border-bottom: 3px solid var(--link-color); }
        .tab-content-container { padding: 20px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .error-message { color: #ff7272; font-weight: bold; background-color: rgba(255, 114, 114, 0.1); border: 1px solid #ff7272; border-radius: 5px; padding: 10px; margin: 15px 0; }
        .info-text { margin-top: 20px; margin-bottom: 20px; }
        .range-info, .date-range-info { font-size: 14px; color: #aaa; margin: 5px 0; }
        .birthday-results-container { margin-top: 20px; text-align: left; max-height: 400px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .result-info { flex-grow: 1; } .result-info h4 { margin: 0 0 5px 0; } .result-info p { margin: 0; color: #aaa; font-size: 0.9rem; }
        .no-results { color: #aaa; text-align: center; padding: 20px; }
        .generate-btn { padding: 12px 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; background-color: var(--button-bg); color: var(--button-text); }
        #generator-controls { margin-bottom: 20px; }
        .generation-info { text-align: center; color: #aaa; margin-top: 20px; min-height: 1.2em; }
        .generator-grid-container { display: flex; flex-direction: column; gap: 10px; }
        .lotto-ball.shuffling { filter: blur(2px); transition: filter 0.1s; }
        #chart-container { width: 100%; max-width: 900px; margin: 40px auto; }
        .lab-container { display: flex; gap: 20px; align-items: flex-start; }
        .lab-number-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--primary-bg); flex-shrink: 0; width: fit-content; }
        .lab-ball-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-color); color: #fff !important; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .lab-ball-btn:hover { opacity: 0.8; }
        .lab-ball-btn.selected { color: var(--button-text) !important; transform: scale(1.1); }
        .lab-results { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background-color: var(--primary-bg); text-align: left; min-height: 300px; }
        .lab-placeholder { color: #888; text-align: center; margin-top: 50px; }
        .lab-results h4 { margin-top: 15px; margin-bottom: 8px; color: var(--link-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .lab-results p { margin: 5px 0; color: #ccc; }
        .lab-results ul { list-style: none; padding-left: 10px; }
        .lab-results li { margin-bottom: 5px; }
        .lab-results .probability { font-weight: bold; color: #fff; }
        .no-data { color: #888; font-style: italic; }
        .evaluate-container { display: flex; gap: 20px; align-items: flex-start; }
        .evaluate-number-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--primary-bg); flex-shrink: 0; width: fit-content; }
        .eval-ball-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-color); color: #fff !important; font-size: 1rem; font-weight: bold; cursor: pointer; transition: transform 0.1s, opacity 0.2s; }
        .eval-ball-btn:hover { opacity: 0.8; }
        .eval-ball-btn.disabled { opacity: 0.3; cursor: not-allowed; }
        .eval-ball-btn.selected { transform: scale(0.9); opacity: 0.5; border-width: 2px; }
        .evaluate-results { flex-grow: 1; text-align: center; }
        .selected-numbers-display { min-height: 60px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; background-color: var(--primary-bg); display: flex; justify-content: center; align-items: center; }
        .selection-guide { color: #888; }
        .selected-numbers-display .ball-container { gap: 15px; }
        .selected-numbers-display .ball-container { gap: 10px; }
        .selected-numbers-display .lotto-ball { width: 30px; height: 30px; font-size: 0.9rem; }
        .evaluate-btn { padding: 12px 25px; font-size: 1.1rem; background-color: var(--button-bg); color: var(--button-text); border: none; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-weight: bold;}
        .evaluate-btn:disabled { background-color: #555; cursor: not-allowed; }
        .evaluation-output-container { text-align: left; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background-color: var(--primary-bg); min-height: 100px; max-height: 400px; overflow-y: auto; }
        .evaluation-output-container .result-item { padding: 10px; }
        .evaluation-output-container .no-match-message { text-align: center; color: #aaa; padding: 30px 0; }
        .evaluation-output-container .lotto-ball { width: 20px; height: 20px; font-size: 0.9rem; }

        @media (max-width: 768px) {
            .left-ad, .right-ad { display: none; }
            .main-content { flex: 1; padding: 15px; }
            .tabs { justify-content: center; /* Center tabs on mobile */ }
            .tab-btn { padding: 10px 15px; font-size: 0.9rem; }
            .lotto-ball { width: 35px; height: 35px; font-size: 1rem; }
            .ball-container { gap: 5px; }
            .form-inputs { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; margin-right: 0; }
            form button { width: 100%; /* Make buttons full width */ }
            h1 { font-size: 1.8rem; }
            .lab-container { flex-direction: column; }
            .lab-number-grid { grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); width: 100%; box-sizing: border-box;}
            .lab-ball-btn { width: 35px; height: 35px; }
            .lab-results { min-height: auto; width: 100%; box-sizing: border-box; padding: 15px; }
            .evaluate-container { flex-direction: column; }
            .evaluate-number-grid { width: 100%; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); box-sizing: border-box;}
            .eval-ball-btn { width: 35px; height: 35px; }
            .evaluate-results { width: 100%; box-sizing: border-box;}
            .selected-numbers-display { padding: 10px; }
            .evaluation-output-container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-ad"> </div>
        <div class="main-content">
            <h1>ğŸ† ë¡œë˜ ì—°êµ¬ì†Œ ğŸ†</h1>

            {% if latest_winning_numbers %}
            <div class="latest-info-section">
                <div class="latest-numbers">
                    <h3>{{ latest_winning_numbers.round }}íšŒ ë‹¹ì²¨ë²ˆí˜¸ ({{ latest_winning_numbers.date }})</h3>
                    <div class="ball-container">
                        {% for num in latest_winning_numbers.main %}
                            {% set ball_color = 'color-yellow' if 1 <= num <= 10 else 'color-blue' if 11 <= num <= 20 else 'color-red' if 21 <= num <= 30 else 'color-gray' if 31 <= num <= 40 else 'color-green' %}
                            <span class="lotto-ball {{ ball_color }}">{{ num }}</span>
                        {% endfor %}
                        <span class="plus-sign">+</span>
                        {% set bonus_num = latest_winning_numbers.bonus %}
                        {% set bonus_ball_color = 'color-yellow' if 1 <= bonus_num <= 10 else 'color-blue' if 11 <= bonus_num <= 20 else 'color-red' if 21 <= bonus_num <= 30 else 'color-gray' if 31 <= bonus_num <= 40 else 'color-green' %}
                        <span class="lotto-ball {{ bonus_ball_color }}">{{ bonus_num }}</span>
                    </div>
                </div>
                <div class="countdown-section">
                    <div class="countdown-item"><h4>ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€</h4><div id="draw-countdown">--ì¼ --ì‹œê°„ --ë¶„ --ì´ˆ</div></div>
                    <div class="countdown-item"><h4>êµ¬ë§¤ ë§ˆê°ê¹Œì§€</h4><div id="sales-countdown">--ì¼ --ì‹œê°„ --ë¶„ --ì´ˆ</div></div>
                </div>
            </div>
            {% endif %}

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab-btn" data-tab="statistics">ë‹¹ì²¨ë²ˆí˜¸ í†µê³„ ë¶„ì„</div>
                    <div class="tab-btn" data-tab="birthday">ê¸°ë…ì¼ ë²ˆí˜¸ ê²€ìƒ‰</div>
                    <div class="tab-btn" data-tab="generator">ìë™ ë²ˆí˜¸ ìƒì„±ê¸°</div>
                    <div class="tab-btn" data-tab="lab">ì‹¤í—˜ì‹¤</div>
                    <div class="tab-btn" data-tab="evaluate">ë‚´ ë²ˆí˜¸ í‰ê°€í•˜ê¸°</div>
                </div>

                <div class="tab-content-container">
                    <div class="tab-content" data-tab="statistics">
                        {% if error_message %}<div class="error-message">{{ error_message }}</div>{% endif %}
                        <form action="/" method="get">
                            <div class="form-inputs">
                                <input type="number" id="start-round" name="start_round" placeholder="1" value="{{ current_start }}"><label for="start-round">íšŒì°¨ë¶€í„°</label>
                                <input type="number" id="end-round" name="end-round" placeholder="{{ latest_round }}" value="{{ current_end }}"><label for="end-round">ê¹Œì§€</label>
                            </div>
                            <button type="submit">í†µê³„ ë¶„ì„</button>
                        </form>
                        <div class="info-text">
                            <p class="range-info">(ì…ë ¥ ê°€ëŠ¥ ë²”ìœ„: 1 ~ {{ latest_round }} íšŒì°¨)</p>
                            <p class="range-info">*ì¶”ì²œ íšŒì°¨ ë²”ìœ„: 836 ~ (í™©ê¸ˆì† ì¶”ì²¨ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)</p>
                            <p class="date-range-info">ë¶„ì„ ê¸°ê°„: {{ end_date }} ~ {{ start_date }}</p>
                        </div>
                        <div id="chart-container"><canvas id="lottoChart"></canvas></div>
                    </div>

                    <div class="tab-content" data-tab="birthday">
                        <form action="/" method="get">
                            <div class="form-inputs">
                                <input type="number" name="birth_month" placeholder="ì›”" value="{{ current_month }}"><label>ì›”</label>
                                <input type="number" name="birth_day" placeholder="ì¼" value="{{ current_day }}"><label>ì¼</label>
                            </div>
                            <button type="submit">ì°¾ì•„ë³´ê¸°</button>
                        </form>
                        <div class="birthday-results-container">
                             {% if birthday_section_open %}
                                {% if birthday_lotto_results %}
                                    {% for result in birthday_lotto_results %}
                                        <div class="result-item">
                                            <div class="result-info"><h4>{{ result.round }}íšŒ ë‹¹ì²¨</h4><p>{{ result.date }}</p></div>
                                            <div class="ball-container">
                                                {% for num in result.main %}
                                                    {% set ball_color = 'color-yellow' if 1 <= num <= 10 else 'color-blue' if 11 <= num <= 20 else 'color-red' if 21 <= num <= 30 else 'color-gray' if 31 <= num <= 40 else 'color-green' %}
                                                    <span class="lotto-ball {{ ball_color }}">{{ num }}</span>
                                                {% endfor %}
                                                <span class="plus-sign">+</span>
                                                {% set bonus_num = result.bonus %}
                                                {% set bonus_ball_color = 'color-yellow' if 1 <= bonus_num <= 10 else 'color-blue' if 11 <= bonus_num <= 20 else 'color-red' if 21 <= bonus_num <= 30 else 'color-gray' if 31 <= bonus_num <= 40 else 'color-green' %}
                                                <span class="lotto-ball {{ bonus_ball_color }}">{{ bonus_num }}</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}<p class="no-results">í•´ë‹¹ ë‚ ì§œì˜ ë‹¹ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-content" data-tab="generator">
                        <div id="generator-controls">
                            <button id="generate-btn" class="generate-btn">ë²ˆí˜¸ ìƒì„±í•˜ê¸°</button>
                            <p id="generation-timestamp" class="generation-info"></p>
                        </div>
                        <div id="generator-grid" class="generator-grid-container"></div>
                    </div>

                    <div class="tab-content" data-tab="lab">
                        <div class="lab-container">
                            <div class="lab-number-grid">
                                {% for i in range(1, 46) %}
                                    {% set ball_color = 'color-yellow' if 1 <= i <= 10 else 'color-blue' if 11 <= i <= 20 else 'color-red' if 21 <= i <= 30 else 'color-gray' if 31 <= i <= 40 else 'color-green' %}
                                    <button class="lab-ball-btn {{ ball_color }}" data-number="{{ i }}">{{ i }}</button>
                                {% endfor %}
                            </div>
                            <div class="lab-results">
                                <p class="lab-placeholder">ì™¼ìª½ì—ì„œ ë¶„ì„í•  ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" data-tab="evaluate">
                        <div class="evaluate-container">
                            <div class="evaluate-number-grid">
                                {% for i in range(1, 46) %}
                                    {% set ball_color = 'color-yellow' if 1 <= i <= 10 else 'color-blue' if 11 <= i <= 20 else 'color-red' if 21 <= i <= 30 else 'color-gray' if 31 <= i <= 40 else 'color-green' %}
                                    <button class="eval-ball-btn {{ ball_color }}" data-number="{{ i }}">{{ i }}</button>
                                {% endfor %}
                            </div>
                            <div class="evaluate-results">
                                <div class="selected-numbers-display">
                                    <p class="selection-guide">ì™¼ìª½ì—ì„œ 6ê°œì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                                </div>
                                <button id="evaluate-btn" class="evaluate-btn" disabled>í‰ê°€í•˜ê¸°</button>
                                <div id="evaluation-output" class="evaluation-output-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-ad"> </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. ê³µí†µ ë³€ìˆ˜ ì„ ì–¸ ---
            const tabsContainer = document.querySelector('.tabs');
            const tabContents = document.querySelectorAll('.tab-content');
            const generateBtn = document.getElementById('generate-btn');
            const generatorGrid = document.getElementById('generator-grid');
            const timestampElem = document.getElementById('generation-timestamp');
            const labNumberGrid = document.querySelector('.lab-number-grid');
            const labResultsContainer = document.querySelector('.lab-results');
            const evaluateNumberGrid = document.querySelector('.evaluate-number-grid');
            const selectedNumbersDisplay = document.querySelector('.selected-numbers-display');
            const evaluateBtn = document.getElementById('evaluate-btn');
            const evaluationOutput = document.getElementById('evaluation-output');

            let shufflingInterval = null;
            let selectedLabBall = null; // ì‹¤í—˜ì‹¤ì—ì„œ ì„ íƒëœ ë²„íŠ¼
            let lottoChartInstance = null; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
            let selectedEvalNumbers = new Set(); // í‰ê°€í•˜ê¸°ì—ì„œ ì„ íƒëœ ë²ˆí˜¸ Set

            // --- 2. ì¹´ìš´íŠ¸ë‹¤ìš´ ê¸°ëŠ¥ ---
            function updateCountdowns() {
                const now = new Date();
                let nextSaturday = new Date(now);
                nextSaturday.setDate(now.getDate() + (6 - now.getDay() + 7) % 7);
                const drawTime = new Date(nextSaturday); drawTime.setHours(20, 35, 0, 0);
                const salesDeadline = new Date(nextSaturday); salesDeadline.setHours(20, 0, 0, 0);
                if (now > drawTime) { drawTime.setDate(drawTime.getDate() + 7); salesDeadline.setDate(salesDeadline.getDate() + 7); }
                else if (now > salesDeadline) { salesDeadline.setDate(salesDeadline.getDate() + 7); }
                const drawElem = document.getElementById('draw-countdown');
                const salesElem = document.getElementById('sales-countdown');
                function updateElement(elem, targetTime) {
                    const diff = targetTime - now; if (diff <= 0) { elem.innerHTML = "ë§ˆê°"; return; }
                    const d=Math.floor(diff/864e5),h=Math.floor(diff%864e5/36e5),m=Math.floor(diff%36e5/6e4),s=Math.floor(diff%6e4/1e3);
                    elem.innerHTML = `${d}ì¼ ${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
                }
                if(drawElem) updateElement(drawElem, drawTime);
                if(salesElem) updateElement(salesElem, salesDeadline);
            }
            if(document.getElementById('draw-countdown')) { // ìš”ì†Œ ì¡´ì¬ í™•ì¸ í›„ ì‹¤í–‰
                setInterval(updateCountdowns, 1000);
                updateCountdowns();
            }

            // --- 3. íƒ­ ê¸°ëŠ¥ ---
            if (tabsContainer) {
                tabsContainer.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('.tab-btn');
                    if (!clickedTab) return;

                    const tabId = clickedTab.dataset.tab;

                    // ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì´ë™ ì‹œ ê´€ë ¨ ê¸°ëŠ¥ ì´ˆê¸°í™”
                    if (tabId !== 'generator') resetGenerator();
                    if (tabId !== 'lab') resetLab();
                    if (tabId !== 'evaluate') resetEvaluate();

                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    clickedTab.classList.add('active');
                    tabContents.forEach(content => content.classList.remove('active'));
                    const activeContent = document.querySelector(`.tab-content[data-tab="${tabId}"]`);
                    if (activeContent) activeContent.classList.add('active');

                    // í†µê³„ íƒ­ì´ í™œì„±í™”ë˜ë©´ ì°¨íŠ¸ ì´ˆê¸°í™” (ì´ë¯¸ ìˆìœ¼ë©´ ë‹¤ì‹œ ì•ˆ ê·¸ë¦¼)
                    if (tabId === 'statistics' && !lottoChartInstance) {
                        initializeChart();
                    }
                });
            }

            // --- 4. ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ ---
            function initializeChart() {
                const chartCtx = document.getElementById('lottoChart');
                if (chartCtx && typeof Chart !== 'undefined') { // Chart.js ë¡œë“œ í™•ì¸
                    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´
                    if (lottoChartInstance) {
                        lottoChartInstance.destroy();
                    }
                    try {
                        const chartLabels = {{ chart_labels | tojson }};
                        const chartData = {{ chart_data | tojson }};
                        const chartOptions = {
                            responsive: true, // ë°˜ì‘í˜• í™œì„±í™”
                            maintainAspectRatio: false, // ë¹„ìœ¨ ìœ ì§€ ë¹„í™œì„±í™” (ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ì¶¤)
                            scales: {
                                y: { beginAtZero: true, ticks: { color: 'rgba(255, 255, 255, 0.7)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                                x: { ticks: { color: 'rgba(255, 255, 255, 0.7)', autoSkip: false }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                            },
                            plugins: { legend: { labels: { color: 'rgba(255, 255, 255, 0.9)' } } }
                        };
                        lottoChartInstance = new Chart(chartCtx.getContext('2d'), {
                            type: 'bar',
                            data: { labels: chartLabels, datasets: [{ label: 'ë²ˆí˜¸ë³„ ë‹¹ì²¨ íšŸìˆ˜', data: chartData, backgroundColor: 'rgba(187, 134, 252, 0.6)', borderColor: 'rgba(187, 134, 252, 1)', borderWidth: 1 }] },
                            options: chartOptions
                        });
                    } catch (e) {
                        console.error("Error initializing chart:", e);
                        // Jinja ë³€ìˆ˜ ë¡œë”© ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
                        const chartContainer = document.getElementById('chart-container');
                        if(chartContainer) chartContainer.innerHTML = '<p style="color:red;">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    console.log("Chart canvas not found or Chart.js not loaded.");
                }
            }


            // --- 5. ìë™ ë²ˆí˜¸ ìƒì„±ê¸° ê¸°ëŠ¥ & ì´ˆê¸°í™” ---
            function resetGenerator() {
                 if (shufflingInterval) clearInterval(shufflingInterval);
                 if (generatorGrid) generatorGrid.innerHTML = '';
                 if (timestampElem) timestampElem.textContent = '';
                 if (generateBtn) {
                      generateBtn.disabled = false;
                      generateBtn.textContent = 'ë²ˆí˜¸ ìƒì„±í•˜ê¸°';
                 }
            }

            if (generateBtn) {
                generateBtn.addEventListener('click', () => {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'ë²ˆí˜¸ ìƒì„± ì¤‘...';
                    timestampElem.textContent = '';
                    generatorGrid.innerHTML = '';
                    if (shufflingInterval) clearInterval(shufflingInterval);

                    const allBalls = [];
                    for (let i = 0; i < 5; i++) {
                        const setContainer = document.createElement('div');
                        setContainer.className = 'ball-container';
                        for (let j = 0; j < 6; j++) {
                            const ball = document.createElement('span');
                            ball.className = 'lotto-ball shuffling';
                            ball.textContent = Math.floor(Math.random() * 45) + 1;
                            setContainer.appendChild(ball);
                            allBalls.push(ball);
                        }
                        generatorGrid.appendChild(setContainer);
                    }

                    shufflingInterval = setInterval(() => {
                        allBalls.forEach(ball => {
                            if (ball.classList.contains('shuffling')) { // ì…”í”Œë§ ì¤‘ì¸ ë³¼ë§Œ ì—…ë°ì´íŠ¸
                                ball.textContent = Math.floor(Math.random() * 45) + 1;
                            }
                        });
                    }, 80);

                    fetch('/api/generate-numbers')
                        .then(response => response.ok ? response.json() : Promise.reject('Network error'))
                        .then(numberSets => {
                            setTimeout(() => {
                                clearInterval(shufflingInterval);
                                const finalNumbers = numberSets.flat();
                                allBalls.forEach((ball, index) => {
                                    setTimeout(() => {
                                        const finalNum = finalNumbers[index];
                                        ball.textContent = finalNum;
                                        ball.classList.remove('shuffling');
                                        let colorClass = 'color-green';
                                        if (finalNum <= 10) colorClass = 'color-yellow';
                                        else if (finalNum <= 20) colorClass = 'color-blue';
                                        else if (finalNum <= 30) colorClass = 'color-red';
                                        else if (finalNum <= 40) colorClass = 'color-gray';
                                        ball.className = 'lotto-ball ' + colorClass; // ì´ì „ í´ë˜ìŠ¤ ì´ˆê¸°í™” í›„ ìƒ‰ìƒ ì ìš©
                                        if (index === allBalls.length - 1) {
                                            generateBtn.disabled = false;
                                            generateBtn.textContent = 'ë‹¤ì‹œ ìƒì„±í•˜ê¸°';
                                            const now = new Date();
                                            timestampElem.textContent = `ìš°ì£¼ì˜ ê¸°ìš´ì„ ëª¨ì•„ ${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ ${now.getHours()}ì‹œ ${now.getMinutes()}ë¶„ ${now.getSeconds()}ì´ˆì— ìƒì„±ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤!`;
                                        }
                                    }, 100 * index);
                                });
                            }, 1000); // 1ì´ˆê°„ ì…”í”Œë§ í›„ ë©ˆì¶¤ ì‹œì‘
                        })
                        .catch(error => {
                            console.error('Error fetching numbers:', error);
                            if(generateBtn) {
                                generateBtn.disabled = false;
                                generateBtn.textContent = 'ì˜¤ë¥˜ ë°œìƒ! ë‹¤ì‹œ ì‹œë„';
                            }
                            clearInterval(shufflingInterval);
                        });
                });
            }

            // --- 6. ì‹¤í—˜ì‹¤ ê¸°ëŠ¥ & ì´ˆê¸°í™” ---
             function resetLab() {
                if (selectedLabBall) {
                    selectedLabBall.classList.remove('selected');
                    selectedLabBall = null;
                }
                if (labResultsContainer) {
                    labResultsContainer.innerHTML = '<p class="lab-placeholder">ì™¼ìª½ì—ì„œ ë¶„ì„í•  ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
                }
            }

            if (labNumberGrid && labResultsContainer) {
                 labNumberGrid.addEventListener('click', (e) => {
                    const clickedBall = e.target.closest('.lab-ball-btn');
                    if (!clickedBall) return;
                    const number = clickedBall.dataset.number;
                    if (selectedLabBall) selectedLabBall.classList.remove('selected');
                    clickedBall.classList.add('selected');
                    selectedLabBall = clickedBall;
                    labResultsContainer.innerHTML = '<p class="lab-placeholder">ë°ì´í„° ë¶„ì„ ì¤‘...</p>';
                    fetch(`/api/analyze-number/${number}`)
                        .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
                        .then(data => displayLabResults(number, data))
                        .catch(error => {
                            console.error('Error fetching analysis:', error);
                            labResultsContainer.innerHTML = '<p class="lab-placeholder" style="color:red;">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                        });
                });
            }
            function displayLabResults(number, data) {
                 if (!labResultsContainer) return;
                 labResultsContainer.innerHTML = `<h4>1. ${number}ë²ˆ ë‹¹ì²¨ í™•ë¥ </h4><p>ì—­ëŒ€ ì´ ${data.appearance_count}ë²ˆ ë“±ì¥ (<span class="probability">${(data.probability * 100).toFixed(2)}%</span>)</p>`;
                 labResultsContainer.innerHTML += formatProbList(`2. ${number}ë²ˆ ì´ì „ì— ë‚˜ì˜¬ í™•ë¥  (Top 3)`, data.prev_top3);
                 labResultsContainer.innerHTML += formatProbList(`3. ${number}ë²ˆ ì´ì „ì— ë‚˜ì˜¬ í™•ë¥  (Bottom 3)`, data.prev_bottom3);
                 labResultsContainer.innerHTML += formatProbList(`4. ${number}ë²ˆ ë‹¤ìŒì— ë‚˜ì˜¬ í™•ë¥  (Top 3)`, data.next_top3);
                 labResultsContainer.innerHTML += formatProbList(`5. ${number}ë²ˆ ë‹¤ìŒì— ë‚˜ì˜¬ í™•ë¥  (Bottom 3)`, data.next_bottom3);
                 labResultsContainer.innerHTML += `<h4>6. ${number}ë²ˆ ìµœëŒ€ ì—°ì† ë“±ì¥ íšŸìˆ˜</h4><p><span class="probability">${data.max_consecutive}íšŒ</span></p>`;
            }
            function formatProbList(title, list) {
                let html = `<h4>${title}</h4>`;
                if (list && list.length > 0) {
                    html += '<ul>';
                    list.forEach(item => { html += `<li>${item[0]}ë²ˆ: <span class="probability">${(item[1] * 100).toFixed(2)}%</span></li>`; });
                    html += '</ul>';
                } else { html += '<p class="no-data">í•´ë‹¹í•˜ëŠ” ìˆ«ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; }
                return html;
            }

            // --- 7. ë‚´ ë²ˆí˜¸ í‰ê°€í•˜ê¸° ê¸°ëŠ¥ & ì´ˆê¸°í™” ---
            function resetEvaluate() {
                 selectedEvalNumbers.clear();
                 if (evaluateNumberGrid) {
                    evaluateNumberGrid.querySelectorAll('.eval-ball-btn').forEach(btn => {
                        btn.classList.remove('selected', 'disabled');
                    });
                 }
                 if(selectedNumbersDisplay) updateSelectedNumbersDisplay();
                 if(evaluateBtn) updateEvaluateButtonState();
                 if(evaluationOutput) evaluationOutput.innerHTML = '';
            }

            if (evaluateNumberGrid && selectedNumbersDisplay && evaluateBtn && evaluationOutput) {
                evaluateNumberGrid.addEventListener('click', (e) => {
                    const clickedBtn = e.target.closest('.eval-ball-btn');
                    if (!clickedBtn || clickedBtn.classList.contains('disabled')) return;
                    const number = parseInt(clickedBtn.dataset.number);
                    if (selectedEvalNumbers.has(number)) {
                        selectedEvalNumbers.delete(number); clickedBtn.classList.remove('selected');
                    } else {
                        if (selectedEvalNumbers.size < 6) { selectedEvalNumbers.add(number); clickedBtn.classList.add('selected'); }
                    }
                    updateSelectedNumbersDisplay();
                    updateEvaluateButtonState();
                    updateGridDisabledState();
                });
                evaluateBtn.addEventListener('click', () => {
                    const numbersQuery = Array.from(selectedEvalNumbers).sort((a, b) => a - b).join(',');
                    evaluationOutput.innerHTML = '<p class="no-results">ê²°ê³¼ë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>';
                    fetch(`/api/evaluate-numbers?numbers=${numbersQuery}`)
                        .then(response => response.ok ? response.json() : Promise.reject('Network error'))
                        .then(matches => displayEvaluationResults(matches))
                        .catch(error => {
                            console.error("Evaluation fetch error:", error);
                            evaluationOutput.innerHTML = '<p class="no-results" style="color:red;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                        });
                });
            }
            function updateSelectedNumbersDisplay() {
                if (!selectedNumbersDisplay) return;
                selectedNumbersDisplay.innerHTML = '';
                if (selectedEvalNumbers.size === 0) { selectedNumbersDisplay.innerHTML = '<p class="selection-guide">ì™¼ìª½ì—ì„œ 6ê°œì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>'; return; }
                const ballContainer = document.createElement('div'); ballContainer.className = 'ball-container';
                const sortedNumbers = Array.from(selectedEvalNumbers).sort((a, b) => a - b);
                sortedNumbers.forEach(num => {
                    const ball = document.createElement('span'); ball.className = 'lotto-ball'; ball.textContent = num;
                    let c = 'color-green'; if (num <= 10) c = 'color-yellow'; else if (num <= 20) c = 'color-blue'; else if (num <= 30) c = 'color-red'; else if (num <= 40) c = 'color-gray'; ball.classList.add(c);
                    ballContainer.appendChild(ball);
                }); selectedNumbersDisplay.appendChild(ballContainer);
            }
            function updateEvaluateButtonState() { if(evaluateBtn) evaluateBtn.disabled = selectedEvalNumbers.size !== 6; }
            function updateGridDisabledState() {
                if (!evaluateNumberGrid) return;
                const allEvalBtns = evaluateNumberGrid.querySelectorAll('.eval-ball-btn');
                if (selectedEvalNumbers.size === 6) { allEvalBtns.forEach(btn => { if (!selectedEvalNumbers.has(parseInt(btn.dataset.number))) btn.classList.add('disabled'); }); }
                else { allEvalBtns.forEach(btn => btn.classList.remove('disabled')); }
            }
            function displayEvaluationResults(matches) {
                if (!evaluationOutput) return;
                evaluationOutput.innerHTML = '';
                if (matches && matches.length > 0) {
                     matches.forEach(result => {
                        const itemDiv = document.createElement('div'); itemDiv.className = 'result-item';
                        const infoDiv = document.createElement('div'); infoDiv.className = 'result-info'; infoDiv.innerHTML = `<h4>${result.round}íšŒ ë‹¹ì²¨</h4><p>${result.date}</p>`;
                        const ballContainer = document.createElement('div'); ballContainer.className = 'ball-container';
                        result.main.forEach(num => {
                            const ball = document.createElement('span'); ball.className = 'lotto-ball'; ball.textContent = num;
                            let c = 'color-green'; if (num <= 10) c = 'color-yellow'; else if (num <= 20) c = 'color-blue'; else if (num <= 30) c = 'color-red'; else if (num <= 40) c = 'color-gray'; ball.classList.add(c);
                            ballContainer.appendChild(ball);
                        });
                        itemDiv.appendChild(infoDiv); itemDiv.appendChild(ballContainer); evaluationOutput.appendChild(itemDiv);
                     });
                } else { evaluationOutput.innerHTML = '<p class="no-match-message">ì—­ëŒ€ ë‹¹ì²¨ ë²ˆí˜¸ì— ì—†ëŠ” ìƒˆë¡œìš´ ì¡°í•©ì…ë‹ˆë‹¤!</p>'; }
            }

            // --- 8. í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ íƒ­ í™œì„±í™” ---
            const defaultTabId = {% if birthday_section_open %}'birthday'{% elif analysis_section_open %}'statistics'{% else %}'statistics'{% endif %};
            const defaultTab = document.querySelector(`.tab-btn[data-tab="${defaultTabId}"]`);
            if (defaultTab) {
                defaultTab.click(); // .click()ìœ¼ë¡œ íƒ­ í™œì„±í™” ë¡œì§ ì‹¤í–‰ + ì°¨íŠ¸ ì´ˆê¸°í™” íŠ¸ë¦¬ê±°
            } else {
                const firstTab = document.querySelector('.tab-btn'); // ê¸°ë³¸ íƒ­ ëª» ì°¾ìœ¼ë©´ ì²« íƒ­ì´ë¼ë„ í™œì„±í™”
                if (firstTab) firstTab.click();
            }

        }); // End of document.addEventListener('DOMContentLoaded', ...)
    </script>
</body>
</html>