<!DOCTYPE html>
<html lang="ko">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-021EWQE074"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-021EWQE074');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Î°úÎòê Ïó∞Íµ¨ÏÜå üèÜ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #121212; --primary-bg: #1e1e1e; --text-color: #e0e0e0;
            --link-color: #bb86fc; --border-color: #333333; --button-bg: #bb86fc;
            --button-text: #121212; --chart-grid-color: rgba(255, 255, 255, 0.1);
        }
        body { margin: 0; font-family: sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .container { display: flex; width: 100%; min-height: 100vh; }
        .left-ad, .right-ad { flex: 1; background-color: var(--primary-bg); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #555; }
        .main-content { flex: 2; padding: 20px 40px; text-align: center; overflow-y: auto; }
        h1 { color: var(--text-color); }
        form { margin: 20px 0; }
        form input[type="number"] { padding: 10px; width: 100px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); font-size: 16px; }
        form button { padding: 10px 20px; border-radius: 5px; border: none; background-color: var(--button-bg); color: var(--button-text); font-size: 16px; font-weight: bold; cursor: pointer; }
        .form-inputs { display: inline-flex; align-items: center; gap: 10px; margin-right: 15px; }
        .latest-info-section { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 30px; }
        .latest-numbers h3 { margin: 0 0 15px 0; font-size: 1rem; color: #aaa; }
        .ball-container { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .lotto-ball { display: inline-flex; justify-content: center; align-items: center; width: 40px; height: 40px; border-radius: 50%; color: #fff; font-weight: bold; font-size: 1.1rem; }
        .color-yellow { background-color: #fbc400; } .color-blue { background-color: #69c8f2; } .color-red { background-color: #ff7272; }
        .color-gray { background-color: #aaa; } .color-green { background-color: #b0d840; }
        .plus-sign { font-size: 1.5rem; color: #888; }
        .countdown-section { display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .countdown-item h4 { margin: 0 0 8px 0; font-size: 0.9rem; color: #aaa; }
        .countdown-item div { font-size: 1.2rem; font-weight: bold; color: var(--link-color); }
        .tab-container { margin-top: 20px; width: 100%; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); }
        .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; color: #888; background-color: transparent; border: none; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--link-color); border-bottom: 3px solid var(--link-color); }
        .tab-content-container { padding: 20px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .error-message { color: #ff7272; font-weight: bold; background-color: rgba(255, 114, 114, 0.1); border: 1px solid #ff7272; border-radius: 5px; padding: 10px; margin: 15px 0; }
        .info-text { margin-top: 20px; margin-bottom: 20px; }
        .range-info, .date-range-info { font-size: 14px; color: #aaa; margin: 5px 0; }
        .birthday-results-container { margin-top: 20px; text-align: left; max-height: 400px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .result-info { flex-grow: 1; } .result-info h4 { margin: 0 0 5px 0; } .result-info p { margin: 0; color: #aaa; font-size: 0.9rem; }
        .no-results { color: #aaa; text-align: center; padding: 20px; }
        .generate-btn { padding: 12px 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; background-color: var(--button-bg); color: var(--button-text); }
        #generator-controls { margin-bottom: 20px; }
        .generation-info { text-align: center; color: #aaa; margin-top: 20px; min-height: 1.2em; }
        .generator-grid-container { display: flex; flex-direction: column; gap: 10px; }
        .lotto-ball.shuffling { filter: blur(2px); transition: filter 0.1s; }
        #chart-container { width: 100%; max-width: 900px; margin: 40px auto; }
        .lab-container { display: flex; gap: 20px; align-items: flex-start; }
        .lab-number-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--primary-bg); flex-shrink: 0; width: fit-content; }
        .lab-ball-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-color); color: var(--text-color); font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .lab-ball-btn:hover { background-color: #555; }
        .lab-ball-btn.selected { color: var(--button-text); transform: scale(1.1); }
        .lab-results { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background-color: var(--primary-bg); text-align: left; min-height: 300px; }
        .lab-placeholder { color: #888; text-align: center; margin-top: 50px; }
        .lab-results h4 { margin-top: 15px; margin-bottom: 8px; color: var(--link-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .lab-results p { margin: 5px 0; color: #ccc; }
        .lab-results ul { list-style: none; padding-left: 10px; }
        .lab-results li { margin-bottom: 5px; }
        .lab-results .probability { font-weight: bold; color: #fff; }
        .no-data { color: #888; font-style: italic; }

        @media (max-width: 768px) {
            .left-ad, .right-ad { display: none; }
            .main-content { flex: 1; padding: 15px; }
            .lotto-ball { width: 35px; height: 35px; font-size: 1rem; }
            .ball-container { gap: 5px; flex-wrap: wrap; }
            .form-inputs { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
            h1 { font-size: 1.8rem; }
            .lab-container { flex-direction: column; }
            .lab-number-grid { grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); width: 100%; }
            .lab-ball-btn { width: 35px; height: 35px; }
            .lab-results { min-height: auto; width: calc(100% - 40px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-ad"> </div>
        <div class="main-content">
            <h1>üèÜ Î°úÎòê Ïó∞Íµ¨ÏÜå üèÜ</h1>

            {% if latest_winning_numbers %}
            <div class="latest-info-section">
                <div class="latest-numbers">
                    <h3>{{ latest_winning_numbers.round }}Ìöå ÎãπÏ≤®Î≤àÌò∏ ({{ latest_winning_numbers.date }})</h3>
                    <div class="ball-container">
                        {% for num in latest_winning_numbers.main %}
                            {% set ball_color = 'color-yellow' if 1 <= num <= 10 else 'color-blue' if 11 <= num <= 20 else 'color-red' if 21 <= num <= 30 else 'color-gray' if 31 <= num <= 40 else 'color-green' %}
                            <span class="lotto-ball {{ ball_color }}">{{ num }}</span>
                        {% endfor %}
                        <span class="plus-sign">+</span>
                        {% set bonus_num = latest_winning_numbers.bonus %}
                        {% set bonus_ball_color = 'color-yellow' if 1 <= bonus_num <= 10 else 'color-blue' if 11 <= bonus_num <= 20 else 'color-red' if 21 <= bonus_num <= 30 else 'color-gray' if 31 <= bonus_num <= 40 else 'color-green' %}
                        <span class="lotto-ball {{ bonus_ball_color }}">{{ bonus_num }}</span>
                    </div>
                </div>
                <div class="countdown-section">
                    <div class="countdown-item"><h4>Îã§Ïùå Ï∂îÏ≤®ÍπåÏßÄ</h4><div id="draw-countdown">--Ïùº --ÏãúÍ∞Ñ --Î∂Ñ --Ï¥à</div></div>
                    <div class="countdown-item"><h4>Íµ¨Îß§ ÎßàÍ∞êÍπåÏßÄ</h4><div id="sales-countdown">--Ïùº --ÏãúÍ∞Ñ --Î∂Ñ --Ï¥à</div></div>
                </div>
            </div>
            {% endif %}

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab-btn" data-tab="statistics">Ïó≠ÎåÄ ÎãπÏ≤®Î≤àÌò∏ ÌÜµÍ≥Ñ Î∂ÑÏÑù</div>
                    <div class="tab-btn" data-tab="birthday">Í∏∞ÎÖêÏùº ÎãπÏ≤®Î≤àÌò∏ Í≤ÄÏÉâ</div>
                    <div class="tab-btn" data-tab="generator">ÏûêÎèô Î≤àÌò∏ ÏÉùÏÑ±Í∏∞</div>
                    <div class="tab-btn" data-tab="lab">Ïã§ÌóòÏã§</div>
                </div>

                <div class="tab-content-container">
                    <div class="tab-content" data-tab="statistics">
                        {% if error_message %}<div class="error-message">{{ error_message }}</div>{% endif %}
                        <form action="/" method="get">
                            <div class="form-inputs">
                                <input type="number" id="start-round" name="start_round" placeholder="1" value="{{ current_start }}"><label for="start-round">ÌöåÏ∞®Î∂ÄÌÑ∞</label>
                                <input type="number" id="end-round" name="end-round" placeholder="{{ latest_round }}" value="{{ current_end }}"><label for="end-round">ÍπåÏßÄ</label>
                            </div>
                            <button type="submit">ÌÜµÍ≥Ñ Î∂ÑÏÑù</button>
                        </form>
                        <div class="info-text">
                            <p class="range-info">(ÏûÖÎ†• Í∞ÄÎä• Î≤îÏúÑ: 1 ~ {{ latest_round }} ÌöåÏ∞®)</p>
                            <p class="range-info">*Ï∂îÏ≤ú ÌöåÏ∞® Î≤îÏúÑ: 836 ~ (Ìô©Í∏àÏÜê Ï∂îÏ≤® Î∞©ÏãùÏúºÎ°ú Î≥ÄÍ≤Ω)</p>
                            <p class="date-range-info">Î∂ÑÏÑù Í∏∞Í∞Ñ: {{ end_date }} ~ {{ start_date }}</p>
                        </div>
                        <div id="chart-container"><canvas id="lottoChart"></canvas></div>
                    </div>

                    <div class="tab-content" data-tab="birthday">
                        <form action="/" method="get">
                            <div class="form-inputs">
                                <input type="number" name="birth_month" placeholder="Ïõî" value="{{ current_month }}"><label>Ïõî</label>
                                <input type="number" name="birth_day" placeholder="Ïùº" value="{{ current_day }}"><label>Ïùº</label>
                            </div>
                            <button type="submit">Ï∞æÏïÑÎ≥¥Í∏∞</button>
                        </form>
                        <div class="birthday-results-container">
                             {% if birthday_section_open %}
                                {% if birthday_lotto_results %}
                                    {% for result in birthday_lotto_results %}
                                        <div class="result-item">
                                            <div class="result-info"><h4>{{ result.round }}Ìöå ÎãπÏ≤®</h4><p>{{ result.date }}</p></div>
                                            <div class="ball-container">
                                                {% for num in result.main %}
                                                    {% set ball_color = 'color-yellow' if 1 <= num <= 10 else 'color-blue' if 11 <= num <= 20 else 'color-red' if 21 <= num <= 30 else 'color-gray' if 31 <= num <= 40 else 'color-green' %}
                                                    <span class="lotto-ball {{ ball_color }}">{{ num }}</span>
                                                {% endfor %}
                                                <span class="plus-sign">+</span>
                                                {% set bonus_num = result.bonus %}
                                                {% set bonus_ball_color = 'color-yellow' if 1 <= bonus_num <= 10 else 'color-blue' if 11 <= bonus_num <= 20 else 'color-red' if 21 <= bonus_num <= 30 else 'color-gray' if 31 <= bonus_num <= 40 else 'color-green' %}
                                                <span class="lotto-ball {{ bonus_ball_color }}">{{ bonus_num }}</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}<p class="no-results">Ìï¥Îãπ ÎÇ†ÏßúÏùò ÎãπÏ≤® Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>{% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-content" data-tab="generator">
                        <div id="generator-controls">
                            <button id="generate-btn" class="generate-btn">Î≤àÌò∏ ÏÉùÏÑ±ÌïòÍ∏∞</button>
                            <p id="generation-timestamp" class="generation-info"></p>
                        </div>
                        <div id="generator-grid" class="generator-grid-container"></div>
                    </div>

                    <div class="tab-content" data-tab="lab">
                        <div class="lab-container">
                            <div class="lab-number-grid">
                                {% for i in range(1, 46) %}
                                    {# Î≤àÌò∏ Í∞íÏóê Îî∞Îùº ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï #}
                                    {% set ball_color = 'color-yellow' if 1 <= i <= 10 else
                                                        'color-blue' if 11 <= i <= 20 else
                                                        'color-red' if 21 <= i <= 30 else
                                                        'color-gray' if 31 <= i <= 40 else
                                                        'color-green' %}
                                    {# Í≤∞Ï†ïÎêú ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§Î•º Î≤ÑÌäºÏóê Ï∂îÍ∞Ä #}
                                    <button class="lab-ball-btn {{ ball_color }}" data-number="{{ i }}">{{ i }}</button>
                                {% endfor %}
                            </div>
                            <div class="lab-results">
                                <p class="lab-placeholder">ÏôºÏ™ΩÏóêÏÑú Î∂ÑÏÑùÌï† Î≤àÌò∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-ad"> </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Í≥µÌÜµ Î≥ÄÏàò ÏÑ†Ïñ∏ ---
            const tabsContainer = document.querySelector('.tabs');
            const tabContents = document.querySelectorAll('.tab-content');
            const generateBtn = document.getElementById('generate-btn');
            const generatorGrid = document.getElementById('generator-grid');
            const timestampElem = document.getElementById('generation-timestamp');
            const labNumberGrid = document.querySelector('.lab-number-grid');
            const labResultsContainer = document.querySelector('.lab-results');
            const labPlaceholder = document.querySelector('.lab-placeholder');

            let shufflingInterval = null;
            let selectedLabBall = null; // Ïã§ÌóòÏã§ÏóêÏÑú ÏÑ†ÌÉùÎêú Î≤àÌò∏ Î≤ÑÌäº ÏöîÏÜå
            let lottoChartInstance = null; // Ï∞®Ìä∏ Í∞ùÏ≤¥Î•º Ï†ÄÏû•Ìï† Î≥ÄÏàò

            // --- 2. Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Í∏∞Îä• ---
            function updateCountdowns() {
                const now = new Date();
                let nextSaturday = new Date(now);
                nextSaturday.setDate(now.getDate() + (6 - now.getDay() + 7) % 7);
                const drawTime = new Date(nextSaturday); drawTime.setHours(20, 35, 0, 0);
                const salesDeadline = new Date(nextSaturday); salesDeadline.setHours(20, 0, 0, 0);
                if (now > drawTime) { drawTime.setDate(drawTime.getDate() + 7); salesDeadline.setDate(salesDeadline.getDate() + 7); }
                else if (now > salesDeadline) { salesDeadline.setDate(salesDeadline.getDate() + 7); }
                const drawElem = document.getElementById('draw-countdown');
                const salesElem = document.getElementById('sales-countdown');
                function updateElement(elem, targetTime) {
                    const diff = targetTime - now; if (diff <= 0) { elem.innerHTML = "ÎßàÍ∞ê"; return; }
                    const d=Math.floor(diff/864e5),h=Math.floor(diff%864e5/36e5),m=Math.floor(diff%36e5/6e4),s=Math.floor(diff%6e4/1e3);
                    elem.innerHTML = `${d}Ïùº ${h}ÏãúÍ∞Ñ ${m}Î∂Ñ ${s}Ï¥à`;
                }
                if(drawElem) updateElement(drawElem, drawTime);
                if(salesElem) updateElement(salesElem, salesDeadline);
            }
            setInterval(updateCountdowns, 1000);
            updateCountdowns();

            // --- 3. ÌÉ≠ Í∏∞Îä• ---
            tabsContainer.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.tab-btn');
                if (!clickedTab) return;

                const tabId = clickedTab.dataset.tab;

                // Îã§Î•∏ ÌÉ≠ÏúºÎ°ú Ïù¥Îèô Ïãú Í¥ÄÎ†® Í∏∞Îä• Ï¥àÍ∏∞Ìôî
                if (tabId !== 'generator') {
                    if (shufflingInterval) clearInterval(shufflingInterval);
                    generatorGrid.innerHTML = '';
                    timestampElem.textContent = '';
                    if(generateBtn) {
                         generateBtn.disabled = false;
                         generateBtn.textContent = 'Î≤àÌò∏ ÏÉùÏÑ±ÌïòÍ∏∞';
                    }
                }
                if (tabId !== 'lab') {
                     if (selectedLabBall) {
                         selectedLabBall.classList.remove('selected');
                         selectedLabBall = null;
                     }
                     if (labResultsContainer) {
                         labResultsContainer.innerHTML = '<p class="lab-placeholder">ÏôºÏ™ΩÏóêÏÑú Î∂ÑÏÑùÌï† Î≤àÌò∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>';
                     }
                }

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                clickedTab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                const activeContent = document.querySelector(`.tab-content[data-tab="${tabId}"]`);
                if (activeContent) activeContent.classList.add('active');

                // ‚ú® ÌÜµÍ≥Ñ ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ Ï∞®Ìä∏Î•º Í∑∏Î¶º (Ïù¥ÎØ∏ Í∑∏Î†§Ï†∏ ÏûàÎã§Î©¥ Îã§Ïãú Í∑∏Î¶¨ÏßÄ ÏïäÏùå)
                if (tabId === 'statistics' && !lottoChartInstance) {
                    initializeChart();
                }
            });

            // --- 4. Ï∞®Ìä∏ ÏÉùÏÑ± Ìï®Ïàò ---
            function initializeChart() {
                const chartCtx = document.getElementById('lottoChart');
                if (chartCtx) {
                    const chartLabels = {{ chart_labels | tojson }};
                    const chartData = {{ chart_data | tojson }};
                    const chartOptions = {
                        scales: {
                            y: { beginAtZero: true, ticks: { color: 'rgba(255, 255, 255, 0.7)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: 'rgba(255, 255, 255, 0.7)', autoSkip: false }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        },
                        plugins: { legend: { labels: { color: 'rgba(255, 255, 255, 0.9)' } } }
                    };
                    // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•
                    lottoChartInstance = new Chart(chartCtx.getContext('2d'), {
                        type: 'bar',
                        data: { labels: chartLabels, datasets: [{ label: 'Î≤àÌò∏Î≥Ñ ÎãπÏ≤® ÌöüÏàò', data: chartData, backgroundColor: 'rgba(187, 134, 252, 0.6)', borderColor: 'rgba(187, 134, 252, 1)', borderWidth: 1 }] },
                        options: chartOptions
                    });
                }
            }

            // --- 5. ÏûêÎèô Î≤àÌò∏ ÏÉùÏÑ±Í∏∞ Í∏∞Îä• ---
            if (generateBtn) {
                generateBtn.addEventListener('click', () => {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'Î≤àÌò∏ ÏÉùÏÑ± Ï§ë...';
                    timestampElem.textContent = '';
                    generatorGrid.innerHTML = '';
                    if (shufflingInterval) clearInterval(shufflingInterval);

                    const allBalls = [];
                    for (let i = 0; i < 5; i++) {
                        const setContainer = document.createElement('div');
                        setContainer.className = 'ball-container';
                        for (let j = 0; j < 6; j++) {
                            const ball = document.createElement('span');
                            ball.className = 'lotto-ball shuffling';
                            ball.textContent = Math.floor(Math.random() * 45) + 1;
                            setContainer.appendChild(ball);
                            allBalls.push(ball);
                        }
                        generatorGrid.appendChild(setContainer);
                    }

                    shufflingInterval = setInterval(() => {
                        allBalls.forEach(ball => {
                            ball.textContent = Math.floor(Math.random() * 45) + 1;
                        });
                    }, 80);

                    fetch('/api/generate-numbers')
                        .then(response => response.json())
                        .then(numberSets => {
                            setTimeout(() => {
                                clearInterval(shufflingInterval);
                                const finalNumbers = numberSets.flat();
                                allBalls.forEach((ball, index) => {
                                    setTimeout(() => {
                                        const finalNum = finalNumbers[index];
                                        ball.textContent = finalNum;
                                        ball.classList.remove('shuffling');
                                        let colorClass = 'color-green';
                                        if (finalNum <= 10) colorClass = 'color-yellow';
                                        else if (finalNum <= 20) colorClass = 'color-blue';
                                        else if (finalNum <= 30) colorClass = 'color-red';
                                        else if (finalNum <= 40) colorClass = 'color-gray';
                                        ball.className = 'lotto-ball ' + colorClass;
                                        if (index === allBalls.length - 1) {
                                            generateBtn.disabled = false;
                                            generateBtn.textContent = 'Îã§Ïãú ÏÉùÏÑ±ÌïòÍ∏∞';
                                            const now = new Date();
                                            timestampElem.textContent = `Ïö∞Ï£ºÏùò Í∏∞Ïö¥ÏùÑ Î™®ÏïÑ ${now.getFullYear()}ÎÖÑ ${now.getMonth() + 1}Ïõî ${now.getDate()}Ïùº ${now.getHours()}Ïãú ${now.getMinutes()}Î∂Ñ ${now.getSeconds()}Ï¥àÏóê ÏÉùÏÑ±Îêú Î≤àÌò∏ÏûÖÎãàÎã§!`;
                                        }
                                    }, 100 * index);
                                });
                            }, 1000);
                        })
                        .catch(error => {
                            console.error('Error fetching numbers:', error);
                            generateBtn.disabled = false;
                            generateBtn.textContent = 'Ïò§Î•ò Î∞úÏÉù! Îã§Ïãú ÏãúÎèÑ';
                            clearInterval(shufflingInterval);
                        });
                });
            }

            // --- 6. Ïã§ÌóòÏã§ Í∏∞Îä• ---
            if (labNumberGrid && labResultsContainer) {
                 labNumberGrid.addEventListener('click', (e) => {
                    const clickedBall = e.target.closest('.lab-ball-btn');
                    if (!clickedBall) return;

                    const number = clickedBall.dataset.number;

                    if (selectedLabBall) selectedLabBall.classList.remove('selected');
                    clickedBall.classList.add('selected');
                    selectedLabBall = clickedBall;

                    labResultsContainer.innerHTML = '<p class="lab-placeholder">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</p>';

                    fetch(`/api/analyze-number/${number}`)
                        .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
                        .then(data => displayLabResults(number, data))
                        .catch(error => {
                            console.error('Error fetching analysis:', error);
                            labResultsContainer.innerHTML = '<p class="lab-placeholder" style="color:red;">Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
                        });
                });
            }

            // Î∂ÑÏÑù Í≤∞Í≥ºÎ•º HTMLÎ°ú Î≥ÄÌôòÌïòÏó¨ ÌëúÏãúÌïòÎäî Ìï®Ïàò
            function displayLabResults(number, data) {
                 if (!labResultsContainer) return;
                 labResultsContainer.innerHTML = `<h4>1. ${number}Î≤à ÎãπÏ≤® ÌôïÎ•†</h4><p>Ïó≠ÎåÄ Ï¥ù ${data.appearance_count}Î≤à Îì±Ïû• (<span class="probability">${(data.probability * 100).toFixed(2)}%</span>)</p>`;
                 labResultsContainer.innerHTML += formatProbList(`2. ${number}Î≤à Ïù¥Ï†ÑÏóê ÎÇòÏò¨ ÌôïÎ•† (Top 3)`, data.prev_top3);
                 labResultsContainer.innerHTML += formatProbList(`3. ${number}Î≤à Ïù¥Ï†ÑÏóê ÎÇòÏò¨ ÌôïÎ•† (Bottom 3)`, data.prev_bottom3);
                 labResultsContainer.innerHTML += formatProbList(`4. ${number}Î≤à Îã§ÏùåÏóê ÎÇòÏò¨ ÌôïÎ•† (Top 3)`, data.next_top3);
                 labResultsContainer.innerHTML += formatProbList(`5. ${number}Î≤à Îã§ÏùåÏóê ÎÇòÏò¨ ÌôïÎ•† (Bottom 3)`, data.next_bottom3);
                 labResultsContainer.innerHTML += `<h4>6. ${number}Î≤à ÏµúÎåÄ Ïó∞ÏÜç Îì±Ïû• ÌöüÏàò</h4><p><span class="probability">${data.max_consecutive}Ìöå</span></p>`;
            }

            // ÌôïÎ•† Î™©Î°ù ÌëúÏãú Helper Ìï®Ïàò
            function formatProbList(title, list) {
                let html = `<h4>${title}</h4>`;
                if (list && list.length > 0) {
                    html += '<ul>';
                    list.forEach(item => { html += `<li>${item[0]}Î≤à: <span class="probability">${(item[1] * 100).toFixed(2)}%</span></li>`; });
                    html += '</ul>';
                } else {
                    html += '<p class="no-data">Ìï¥ÎãπÌïòÎäî Ïà´ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                }
                return html;
            }

             // --- 7. ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Î≥∏ ÌÉ≠ ÌôúÏÑ±Ìôî ---
             // Ïù¥ ÏΩîÎìúÎäî Îã§Î•∏ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§Ïù¥ Î™®Îëê ÏÑ§Ï†ïÎêú *ÌõÑ*Ïóê Ïã§ÌñâÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.
             const defaultTabId = {% if birthday_section_open %}'birthday'{% elif analysis_section_open %}'statistics'{% else %}'statistics'{% endif %};
             const defaultTab = document.querySelector(`.tab-btn[data-tab="${defaultTabId}"]`);
             if (defaultTab) {
                 defaultTab.click(); // .click()ÏúºÎ°ú ÌÉ≠ ÌôúÏÑ±Ìôî Î°úÏßÅ Ïã§Ìñâ
             } else {
                 // ÌòπÏãú defaultTabÏùÑ Î™ª Ï∞æÏùÑ Í≤ΩÏö∞ ÎåÄÎπÑ, Ï≤´ Î≤àÏß∏ ÌÉ≠Ïù¥ÎùºÎèÑ ÌôúÏÑ±Ìôî
                 const firstTab = document.querySelector('.tab-btn');
                 if (firstTab) firstTab.click();
             }

        }); // End of document.addEventListener('DOMContentLoaded', ...)
    </script>
</body>
</html>